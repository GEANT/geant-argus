{% extends "htmx/incidents/incident_detail.html" %}
{% load incident_extras %}
{% block head %}
  {{ block.super }}
  <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
{% endblock head %}
{% block main %}
  <nav class="breadcrumb flex items-center justify-center py-4"
       aria-label="breadcrumbs">
    <ul>
      <li>
        <a href="#">[{{ incident.pk }}]</a>
      </li>
      <li class="is-active">
        <a href="#" aria-current="page">[{{ incident.source_incident_id }}]</a>
      </li>
    </ul>
  </nav>
  {% if incident.metadata %}
    <h2>{{ incident.metadata.description }}</h2>
  {% else %}
    <h2>{{ incident.description }}</h2>
  {% endif %}
  {% block incident_detail %}
    {% if incident.metadata and incident.metadata.version == "v0a4" %}
      <section id="endpoints" class="test">
        <div class="text-3xl mb-4">Endpoints</div>
        {% for endpoint_type, endpoints in incident.metadata.endpoints.items %}
          {% if endpoints %}
            <div class="bg-skin-active-section-body mb-4">
              <div id="endpoint_type"
                   class="bg-skin-active-section border border-skin-active-section text-skin-active-section px-4 py-3 rounded relative mb-4">
                <div class="flex justify-between items-center">
                  <div class="text-xl capitalize">{{ endpoint_type }}</div>
                </div>
              </div>
              <div class=" p-6">
                <table class="min-w-full border-skin-table bg-skin-fill border">
                  <thead class="bg-skin-table-head text-skin-table-header">
                    <tr>
                      <th class="py-2 px-4">Endpoint Name</th>
                      <th class="py-2 px-4">Alarm ID</th>
                      <th class="py-2 px-4">Status</th>
                      <th class="py-2 px-4">Init Time</th>
                      <th class="py-2 px-4">Clear Time</th>
                      <th class="py-2 px-4">Properties</th>
                    </tr>
                  </thead>
                  {% for endpoint in endpoints %}
                    <tbody class="bg-skin-table-row border-skin-table-row">
                      {% with forloop.counter as endpoint_counter %}
                        <tr class="border-skin-table-row border-t">
                          <td class="py-2 px-4 " rowspan="{{ endpoint.events|length }}">{{ endpoint.name }}</td>
                          {% for event in endpoint.events %}
                            {% if not forloop.first %}<tr class="border-t">{% endif %}
                              <td class="py-2 px-4 ">{{ event.properties.id }}</td>
                              <td class="py-2 px-4 ">
                                <div class="flex items-center">
                                  <div class="inline-block w-4 h-4 mr-2 {% if event.is_up %} bg-green-500 {% else %} bg-red-500 {% endif %} rounded-full">
                                  </div>
                                  {{ event.is_up|yesno:"Up,Down" }}
                                </div>
                              </td>
                              <td class="py-2 px-4 ">{{ event.init_time }}</td>
                              <td class="py-2 px-4 ">{{ event.clear_time }}</td>
                              <td class="py-2 px-4 ">
                                <button type="button"
                                        class="bg-skin-button-accent hover:bg-skin-button-accent-hover text-skin-base py-1 px-2 rounded"
                                        _="on click add .open to #modal_{{ endpoint_type }}_{{ endpoint_counter }}_{{ forloop.counter }}">
                                  See
                                  more
                                </button>
                              </td>
                              {% if not forloop.last %}</tr>{% endif %}
                          {% endfor %}
                        </tr>
                      {% endwith %}
                    </tbody>
                  {% endfor %}
                </table>
              </div>
            </div>
          {% else %}
            <div id="endpoint_type"
                 class="bg-skin-disabled-section border border-skin-disabled-section text-skin-disabled-section px-4 py-3 rounded relative mb-4 capitalize">
              <div class="text-xl">{{ endpoint_type }}</div>
            </div>
          {% endif %}
        {% endfor %}
      </section>
      {% for endpoint_type, endpoints in incident.metadata.endpoints.items %}
        {% for endpoint in endpoints %}
          {% with forloop.counter as endpoint_counter %}
            {% for event in endpoint.events %}
              {% include "htmx/incidents/_incident_event_properties_modal.html" with endpoint_name=endpoint.name event=event endpoint_type=endpoint_type endpoint_counter=endpoint_counter event_counter=forloop.counter %}
            {% endfor %}
          {% endwith %}
        {% endfor %}
      {% endfor %}
    {% else %}
      <p class="text-red-500">Cannot show additional information (mismatched metadata version)</p>
    {% endif %}
  {% endblock incident_detail %}
{% endblock main %}
